{% extends 'base.html' %}
{% load get_item %}
{% block title %}Yoklama Al{% endblock %}


{% block content %}
<style>
.form-select:focus {
    box-shadow: none !important;
}
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">üìã Yoklama Al</h2>
                <div class="badge bg-info fs-6">
                    {{ user.get_full_name }} - {{ user.get_role_display }}
                </div>
            </div>

            <!-- Sƒ±nƒ±f ve Tarih Se√ßimi -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Sƒ±nƒ±f ve Tarih Se√ßimi</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
    <!-- Hidden input'lar - sadece deƒüi≈ümeyecek olanlar -->
    <input type="hidden" name="tarih" value="{{ selected_tarih }}">
    
    <!-- Sƒ±nƒ±f Se√ßimi -->
    <div class="col-md-3">
        <label class="form-label">üéì Sƒ±nƒ±f Seviyesi:</label>
        <select name="sinif_seviye" class="form-select" onchange="this.form.submit()">
            <option value="">-- Sƒ±nƒ±f Se√ßin --</option>
            {% regroup siniflar by sinif_seviye as sinif_groups %}
            {% for group in sinif_groups %}
                <option value="{{ group.grouper }}" {% if group.grouper == selected_sinif %}selected{% endif %}>
                    {{ group.grouper }}. Sƒ±nƒ±f
                </option>
            {% endfor %}
        </select>
    </div>
    
    <!-- ≈ûube Se√ßimi -->
    {% if selected_sinif %}
    <div class="col-md-3">
        <label class="form-label">üè´ ≈ûube:</label>
        <select name="sube" class="form-select" onchange="this.form.submit()">
            {% if user_role == 'ogretmen' %}
                {% for sube in ogretmen_subeleri|get_item:selected_sinif %}
                    <option value="{{ sube }}" {% if selected_sube == sube %}selected{% endif %}>
                        {{ sube }} ≈ûubesi
                    </option>
                {% endfor %}
            {% else %}
                <option value="A" {% if selected_sube == 'A' %}selected{% endif %}>A ≈ûubesi</option>
                <option value="B" {% if selected_sube == 'B' %}selected{% endif %}>B ≈ûubesi</option>
                <option value="C" {% if selected_sube == 'C' %}selected{% endif %}>C ≈ûubesi</option>
                <option value="D" {% if selected_sube == 'D' %}selected{% endif %}>D ≈ûubesi</option>
            {% endif %}
        </select>
    </div>
    {% endif %}
</form>
                </div>
            </div>

            {% if ogrenciler %}
                <!-- Yoklama Formu -->
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                {% if selected_sinif == 'anasinif' %}
                                    Ana Sƒ±nƒ±fƒ±
                                {% else %}
                                    {{ selected_sinif }}. Sƒ±nƒ±f
                                {% endif %}
                                {% if selected_sube %} - {{ selected_sube }} ≈ûubesi{% endif %}
                                Yoklama Listesi
                            </h5>
                            <div class="badge bg-light text-dark fs-6">
                                {{ selected_tarih }} | {{ ogrenciler|length }} √ñƒürenci
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <form method="post">
                            {% csrf_token %}
                            
                            <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
                            <div class="p-3 border-bottom bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-sm btn-success me-2" onclick="selectAll(true)">
                                            ‚úÖ T√ºm√ºn√º Se√ß
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger me-2" onclick="selectAll(false)">
                                            ‚ùå T√ºm√ºn√º Kaldƒ±r
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <small class="text-muted">
                                            üí° ƒ∞pucu: Devamsƒ±z √∂ƒürencileri i≈üaretleyin
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- √ñƒürenci Listesi -->
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 60px;">Devamsƒ±z</th>
                                            <th>√ñƒürenci Bilgileri</th>
                                            <th style="width: 150px;">Mazeret</th>
                                            <th style="width: 120px;">Ders Sayƒ±sƒ±</th>
                                            <th>A√ßƒ±klama</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ogrenci in ogrenciler %}
                                            {% with devamsizlik=devamsizliklar|default_if_none:''|get_item:ogrenci.id %}
                                                <tr class="{% if devamsizlik %}table-warning{% endif %}">
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="devamsiz_{{ ogrenci.id }}" 
                                                               class="form-check-input devamsiz-checkbox" 
                                                               {% if devamsizlik %}checked{% endif %}
                                                               onchange="toggleRow(this)">
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-3">
                                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                                     style="width: 40px; height: 40px; font-size: 14px; font-weight: bold;">
                                                                    {{ ogrenci.ad_soyad|slice:":2"|upper }}
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <strong>{{ ogrenci.ad_soyad }}</strong><br>
                                                                <small class="text-muted">
                                                                    {{ ogrenci.sinif_info }} - No: {{ ogrenci.okul_numarasi }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <select name="mazeret_{{ ogrenci.id }}" 
                                                                class="form-select form-select-sm mazeret-select" 
                                                                {% if not devamsizlik %}disabled{% endif %}>
                                                            {% for value, label in mazeret_choices %}
                                                                <option value="{{ value }}" 
                                                                        {% if devamsizlik and devamsizlik.mazeret == value %}selected
                                                                        {% elif not devamsizlik and value == 'mazeretsiz' %}selected{% endif %}>
                                                                    {{ label }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" 
                                                               name="ders_sayisi_{{ ogrenci.id }}" 
                                                               class="form-control form-control-sm ders-input" 
                                                               value="{{ devamsizlik.ders_sayisi|default:1 }}" 
                                                               min="1" max="8"
                                                               {% if not devamsizlik %}disabled{% endif %}>
                                                    </td>
                                                    <td>
                                                        <input type="text" 
                                                               name="aciklama_{{ ogrenci.id }}" 
                                                               class="form-control form-control-sm aciklama-input" 
                                                               value="{{ devamsizlik.aciklama|default:'' }}" 
                                                               placeholder="A√ßƒ±klama..."
                                                               {% if not devamsizlik %}disabled{% endif %}>
                                                    </td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Kaydet Butonu -->
                            <div class="card-footer text-center">
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    üíæ Yoklamayƒ± Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
            {% elif selected_sinif %}
                <!-- √ñƒürenci Yok -->
                <div class="alert alert-warning text-center">
                    <h5>Bu sƒ±nƒ±fta √∂ƒürenci bulunamadƒ±</h5>
                    <p>Se√ßilen sƒ±nƒ±fa hen√ºz √∂ƒürenci kaydedilmemi≈ü veya eri≈üim yetkiniz yok.</p>
                </div>
                
            {% else %}
                <!-- Ba≈ülangƒ±√ß Durumu -->
                <div class="text-center py-5">
                    <div class="card border-0">
                        <div class="card-body">
                            <div class="mb-4">
                                <i class="fas fa-clipboard-check fa-5x text-muted"></i>
                            </div>
                            <h4 class="text-muted">Yoklama Almaya Ho≈ü Geldiniz</h4>
                            <p class="text-muted">Ba≈ülamak i√ßin yukarƒ±dan tarih ve sƒ±nƒ±f se√ßin.</p>
                            
                            {% if user_role == 'ogretmen' %}
                                <div class="alert alert-info mt-3">
                                    <strong>√ñƒüretmen Yetkileri:</strong><br>
                                    Sadece atandƒ±ƒüƒ±nƒ±z sƒ±nƒ±flara yoklama alabilirsiniz.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
// JavaScript fonksiyonlarƒ±
function selectAll(checked) {
    const checkboxes = document.querySelectorAll('.devamsiz-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checked;
        toggleRow(cb);
    });
}

function toggleRow(checkbox) {
    const row = checkbox.closest('tr');
    const mazeretSelect = row.querySelector('.mazeret-select');
    const dersInput = row.querySelector('.ders-input');
    const aciklamaInput = row.querySelector('.aciklama-input');
    
    if (checkbox.checked) {
        row.classList.add('table-warning');
        mazeretSelect.disabled = false;
        dersInput.disabled = false;
        aciklamaInput.disabled = false;
    } else {
        row.classList.remove('table-warning');
        mazeretSelect.disabled = true;
        dersInput.disabled = true;
        aciklamaInput.disabled = true;
        // Deƒüerleri sƒ±fƒ±rla
        mazeretSelect.value = 'mazeretsiz';
        dersInput.value = 1;
        aciklamaInput.value = '';
    }
}

// Sayfa y√ºklendiƒüinde mevcut se√ßimleri kontrol et
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.devamsiz-checkbox').forEach(cb => {
        toggleRow(cb);
    });
});
</script>
{% endblock %}