{% extends 'base.html' %}
{% load get_item %}
{% block title %}Yoklama Al - Okul Yönetimi{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="welcome-card text-center mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Yoklama Al
                </h2>
                <p class="mb-0 opacity-75">Öğrenci devamsızlık takibi</p>
            </div>
            <div class="user-info">
                <i class="fas fa-user-circle me-2"></i>
                {{ user.get_full_name }} - {{ user.get_role_display }}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Sınıf ve Tarih Seçimi -->
            <div class="stats-card mb-4">
                <div class="card-header bg-gradient-orange text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Sınıf ve Tarih Seçimi
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <input type="hidden" name="tarih" value="{{ selected_tarih }}">
                        
                        <!-- Sınıf Seçimi -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-graduation-cap me-2 text-orange"></i>
                                Sınıf Seviyesi
                            </label>
                            <select name="sinif_seviye" class="form-control" onchange="this.form.submit()">
                                <option value="">-- Sınıf Seçin --</option>
                                {% regroup siniflar by sinif_seviye as sinif_groups %}
                                {% for group in sinif_groups %}
                                    <option value="{{ group.grouper }}" {% if group.grouper == selected_sinif %}selected{% endif %}>
                                        {{ group.grouper }}. Sınıf
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Şube Seçimi -->
                        {% if selected_sinif %}
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-door-open me-2 text-orange"></i>
                                Şube
                            </label>
                            <select name="sube" class="form-control" onchange="this.form.submit()">
                                {% if user_role == 'ogretmen' %}
                                    {% for sube in ogretmen_subeleri|get_item:selected_sinif %}
                                        <option value="{{ sube }}" {% if selected_sube == sube %}selected{% endif %}>
                                            {{ sube }} Şubesi
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="A" {% if selected_sube == 'A' %}selected{% endif %}>A Şubesi</option>
                                    <option value="B" {% if selected_sube == 'B' %}selected{% endif %}>B Şubesi</option>
                                    <option value="C" {% if selected_sube == 'C' %}selected{% endif %}>C Şubesi</option>
                                    <option value="D" {% if selected_sube == 'D' %}selected{% endif %}>D Şubesi</option>
                                {% endif %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <!-- Tarih Bilgisi -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar me-2 text-orange"></i>
                                Seçilen Tarih
                            </label>
                            <div class="form-control bg-light text-muted">
                                {{ selected_tarih }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if ogrenciler %}
                <!-- Yoklama Formu -->
                <div class="stats-card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>
                                {% if selected_sinif == 'anasinif' %}
                                    Ana Sınıfı
                                {% else %}
                                    {{ selected_sinif }}. Sınıf
                                {% endif %}
                                {% if selected_sube %} - {{ selected_sube }} Şubesi{% endif %}
                                Yoklama Listesi
                            </h5>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ selected_tarih }}
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-users me-1"></i>
                                    {{ ogrenciler|length }} Öğrenci
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <form method="post">
                            {% csrf_token %}
                            
                            <!-- Hızlı İşlemler -->
                            <div class="p-3 border-bottom bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-success btn-sm" onclick="selectAll(true)">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Tümünü Seç
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="selectAll(false)">
                                                <i class="fas fa-times-circle me-1"></i>
                                                Tümünü Kaldır
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Devamsız öğrencileri işaretleyin
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Öğrenci Listesi -->
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 80px;" class="text-center">Devamsız</th>
                                            <th>Öğrenci Bilgileri</th>
                                            <th style="width: 150px;">Mazeret</th>
                                            <th style="width: 120px;">Ders Sayısı</th>
                                            <th>Açıklama</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ogrenci in ogrenciler %}
                                            {% with devamsizlik=devamsizliklar|default_if_none:''|get_item:ogrenci.id %}
                                                <tr class="{% if devamsizlik %}table-warning{% endif %} student-row">
                                                    <td class="text-center">
                                                        <div class="form-check">
                                                            <input type="checkbox" 
                                                                   name="devamsiz_{{ ogrenci.id }}" 
                                                                   class="form-check-input devamsiz-checkbox" 
                                                                   {% if devamsizlik %}checked{% endif %}
                                                                   onchange="toggleRow(this)">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="student-avatar me-3">
                                                                {{ ogrenci.ad_soyad|slice:":2"|upper }}
                                                            </div>
                                                            <div>
                                                                <div class="fw-semibold">{{ ogrenci.ad_soyad }}</div>
                                                                <small class="text-muted">
                                                                    {{ ogrenci.sinif_info }} - No: {{ ogrenci.okul_numarasi }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <select name="mazeret_{{ ogrenci.id }}" 
                                                                class="form-control form-control-sm mazeret-select" 
                                                                {% if not devamsizlik %}disabled{% endif %}>
                                                            {% for value, label in mazeret_choices %}
                                                                <option value="{{ value }}" 
                                                                        {% if devamsizlik and devamsizlik.mazeret == value %}selected
                                                                        {% elif not devamsizlik and value == 'mazeretsiz' %}selected{% endif %}>
                                                                    {{ label }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" 
                                                               name="ders_sayisi_{{ ogrenci.id }}" 
                                                               class="form-control form-control-sm ders-input" 
                                                               value="{{ devamsizlik.ders_sayisi|default:1 }}" 
                                                               min="1" max="8"
                                                               {% if not devamsizlik %}disabled{% endif %}>
                                                    </td>
                                                    <td>
                                                        <input type="text" 
                                                               name="aciklama_{{ ogrenci.id }}" 
                                                               class="form-control form-control-sm aciklama-input" 
                                                               value="{{ devamsizlik.aciklama|default:'' }}" 
                                                               placeholder="Açıklama..."
                                                               {% if not devamsizlik %}disabled{% endif %}>
                                                    </td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Kaydet Butonu -->
                            <div class="card-footer text-center bg-light">
                                <button type="submit" class="btn-custom-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    Yoklamayı Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
            {% elif selected_sinif %}
                <!-- Öğrenci Yok -->
                <div class="stats-card border-warning">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-user-slash fa-4x text-warning"></i>
                        </div>
                        <h5 class="text-warning">Bu sınıfta öğrenci bulunamadı</h5>
                        <p class="text-muted">Seçilen sınıfa henüz öğrenci kaydedilmemiş veya erişim yetkiniz yok.</p>
                    </div>
                </div>
                
            {% else %}
                <!-- Başlangıç Durumu -->
                <div class="stats-card">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-clipboard-check fa-5x text-orange"></i>
                        </div>
                        <h4 class="text-orange mb-3">Yoklama Almaya Hoş Geldiniz</h4>
                        <p class="text-muted mb-4">Başlamak için yukarıdan sınıf seçin.</p>
                        
                        {% if user_role == 'ogretmen' %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Öğretmen Yetkileri:</strong><br>
                                Sadece atandığınız sınıflara yoklama alabilirsiniz.
                            </div>
                        {% endif %}
                        
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                    <h6>Sınıf Seçimi</h6>
                                    <small class="text-muted">Yoklama alacağınız sınıfı seçin</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="fas fa-check-square fa-2x text-success mb-2"></i>
                                    <h6>Devamsızlık İşaretle</h6>
                                    <small class="text-muted">Devamsız öğrencileri işaretleyin</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="fas fa-save fa-2x text-warning mb-2"></i>
                                    <h6>Kaydet</h6>
                                    <small class="text-muted">Yoklama bilgilerini kaydedin</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
// JavaScript fonksiyonları
function selectAll(checked) {
    const checkboxes = document.querySelectorAll('.devamsiz-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checked;
        toggleRow(cb);
    });
}

function toggleRow(checkbox) {
    const row = checkbox.closest('tr');
    const mazeretSelect = row.querySelector('.mazeret-select');
    const dersInput = row.querySelector('.ders-input');
    const aciklamaInput = row.querySelector('.aciklama-input');
    
    if (checkbox.checked) {
        row.classList.add('table-warning');
        mazeretSelect.disabled = false;
        dersInput.disabled = false;
        aciklamaInput.disabled = false;
    } else {
        row.classList.remove('table-warning');
        mazeretSelect.disabled = true;
        dersInput.disabled = true;
        aciklamaInput.disabled = true;
        // Değerleri sıfırla
        mazeretSelect.value = 'mazeretsiz';
        dersInput.value = 1;
        aciklamaInput.value = '';
    }
}

// Sayfa yüklendiğinde mevcut seçimleri kontrol et
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.devamsiz-checkbox').forEach(cb => {
        toggleRow(cb);
    });
});
</script>
{% endblock %}